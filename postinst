#!/bin/bash
set -e
if [ ! -d "/lib/modules/$(uname -r)/updates/" ]
then
	mkdir "/lib/modules/$(uname -r)/updates/"
fi
cp -f /usr/lib/modules/*.ko "/lib/modules/$(uname -r)/updates/"

#echo "Running depmod, please wait ..."
#depmod -A
#echo "done running depmod"

echo "loading modules ..."
#keeping the order is important ....
mods=("axiom_mem_manager.ko" "axiom_mem_dev.ko" "axiom_netdev.ko")
for kmod in  ${mods[@]}
do
#	kmod=${file%%.ko}
#	kmod=${kmod##*/}
	loaded="$(lsmod | grep ${kmod%%.ko})"
	if [[ ! -z "$loaded" ]]
	then
		echo -e "\e[31m\e[5m[Unloading]\e[0m $kmod ..."
		rmmod $kmod
	fi
	echo -e "\e[33m\e[5m[Loading]\e[0m $kmod ..."
	insmod /usr/lib/modules/$kmod
	echo -e "\e[32m\e[5m[Done Loading]\e[0m $kmod ..."
done
echo "done loading modules"

return 0
